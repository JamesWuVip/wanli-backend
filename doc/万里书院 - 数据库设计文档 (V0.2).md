### **万里书院 \- 数据库设计文档 (V0.2)**

* **文档ID:** WANLI-DB-V0.2  
* **最后更新:** 2025年8月22日  
* **更新内容:** 修正版本号，添加实现状态说明，补充homeworks表完整定义
* **核心原则:** 本设计旨在通过一个分层的、可扩展的关系型数据模型，完整地支持从平台管理、内容创建、多样化题目设计，到学生提交和教师批改的全业务流程。**所有核心业务表均包含伪删除字段 (deleted\_at)**。

#### **实现状态说明**

本数据库设计采用分阶段实现策略：

**✅ SP1阶段 (已实现):**
- `users` 表 - 用户管理
- `courses` 表 - 课程管理  
- `lessons` 表 - 课时管理

**🔄 SP2阶段 (规划中):**
- `homeworks` 表 - 作业管理
- `questions` 表 - 题目管理
- `submissions` 表 - 提交记录
- `student_answers` 表 - 学员答案

**📋 未来阶段:**
- `franchises` 表 - 加盟商管理
- 其他扩展功能表

#### **1\. 实体关系图 (ERD \- Textual Representation)**

\+---------------+   \+-----------+   \+-----------+   \+-----------+   \+----------------+  
|  franchises |o--|   users   |o--|  courses  |o--|  lessons  |o--|   homeworks    |  
|---------------|   |-----------|   |-----------|   |-----------|   |----------------|  
| id (PK)       |---| franchise\_id|---| creator\_id|---| course\_id |---| lesson\_id (FK) |  
| name          |   | id (PK)   |   | id (PK)   |   | id (PK)   |   | id (PK)        |  
\+---------------+   | role      |   | title     |   | title     |   | title          |  
                    \+-----------+   \+-----------+   \+-----------+   \+----------------+  
                         | |                                                |  
                         | \+------------------------------------------------+  
                         |                                                  |  
\+---------------+        |   \+---------------+     \+----------------+       |  
|    classes    |o--|----|   |  submissions  |o---| student\_answers|       |  
|---------------|   |        |---------------|     |----------------|       |  
| id (PK)       |   |        | id (PK)       |-----| submission\_id  |       |  
| franchise\_id  |   \+--------| student\_id    |     | id (PK)        |       |  
| name          |            | homework\_id   |     | question\_id(FK)|-------+  
\+---------------+            | grader\_id     |     \+----------------+       |  
                             \+---------------+                              |  
                                                                            |  
                                                    \+----------------+      |  
                                                    |   questions    |      |  
                                                    |----------------|      |  
                                                    | id (PK)        |o-----+  
                                                    | homework\_id(FK)|o-----+  
                                                    | parent\_id (FK) |\<--+  
                                                    \+----------------+   |  
                                                                         |  
                                                                         \+--

#### **2\. 表结构详情 (Table Schemas)**

##### **史诗 4: 平台与门店管理**

* **Table: franchises (门店表)**  
  * **描述:** 存储所有加盟门店的基本信息。

| 列名 (Column) | 类型 (Type) | 约束 (Constraints) | 描述 |
| :---- | :---- | :---- | :---- |
| id | UUID | Primary Key, Not Null | 门店唯一标识符 |
| name | VARCHAR(255) | Not Null | 门店名称 |
| status | VARCHAR(50) | Not Null, Default 'ACTIVE' | 门店状态 ('ACTIVE', 'INACTIVE') |
| created\_at | TIMESTAMPTZ | Not Null |  |
| updated\_at | TIMESTAMPTZ | Not Null |  |
| deleted\_at | TIMESTAMPTZ |  | **(新增)** 伪删除标记 |

* **Table: users (用户表)**  
  * **描述:** 存储所有系统用户（平台管理员、总部教师、门店管理员、门店教师、学员）。

| 列名 (Column) | 类型 (Type) | 约束 (Constraints) | 描述 |
| :---- | :---- | :---- | :---- |
| id | UUID | Primary Key, Not Null | 用户唯一标识符 |
| franchise\_id | UUID | Foreign Key (franchises.id) | 所属门店ID (平台人员此字段可为空) |
| username | VARCHAR(50) | Unique, Not Null | 用户名 |
| password | VARCHAR(255) | Not Null | 加密后的密码 |
| email | VARCHAR(100) | Unique, Not Null | 邮箱 |
| role | VARCHAR(50) | Not Null | 角色 (e.g., 'ROLE\_HQ\_TEACHER') |
| created\_at | TIMESTAMPTZ | Not Null |  |
| updated\_at | TIMESTAMPTZ | Not Null |  |
| deleted\_at | TIMESTAMPTZ |  | **(新增)** 伪删除标记 |

* **Table: classes (班级表)**  
  * **描述:** 存储门店内用于组织学生的班级信息。

| 列名 (Column) | 类型 (Type) | 约束 (Constraints) | 描述 |
| :---- | :---- | :---- | :---- |
| id | UUID | Primary Key, Not Null | 班级唯一标识符 |
| franchise\_id | UUID | Foreign Key (franchises.id), Not Null | 所属门店ID |
| name | VARCHAR(100) | Not Null | 班级名称 |
| created\_at | TIMESTAMPTZ | Not Null |  |
| deleted\_at | TIMESTAMPTZ |  | **(新增)** 伪删除标记 |

* **Table: class\_members (班级成员关联表)**  
  * **描述:** 建立班级与学生/教师的多对多关系。

| 列名 (Column) | 类型 (Type) | 约束 (Constraints) | 描述 |
| :---- | :---- | :---- | :---- |
| class\_id | UUID | Foreign Key (classes.id), Not Null | 班级ID |
| user\_id | UUID | Foreign Key (users.id), Not Null | 用户ID (学生或教师) |

##### **史诗 1: 课程与内容管理**

* Table: courses (课程表)  
* 描述: 存储由总部教师创建的核心教学内容单元——课程。

| 列名 (Column) | 类型 (Type) | 约束 (Constraints) | 描述 |
| :---- | :---- | :---- | :---- |
| id | UUID | Primary Key, Not Null | 课程唯一标识符 |
| creator\_id | UUID | Foreign Key (users.id), Not Null | 创建该课程的总部教师ID |
| title | VARCHAR(255) | Not Null | 课程标题 |
| description | TEXT |  | 课程的详细描述 |
| status | VARCHAR(50) | Not Null, Default 'DRAFT' | 课程状态 ('DRAFT', 'PUBLISHED') |
| created\_at | TIMESTAMPTZ | Not Null | 创建时间 |
| updated\_at | TIMESTAMPTZ | Not Null | 最后更新时间 |
| deleted\_at | TIMESTAMPTZ |  | (软删除) 伪删除标记 |

* Table: lessons (课时表)  
* 描述: 存储课程内部的、有序的教学小节——课时。

| 列名 (Column) | 类型 (Type) | 约束 (Constraints) | 描述 |
| :---- | :---- | :---- | :---- |
| id | UUID | Primary Key, Not Null | 课时唯一标识符 |
| course\_id | UUID | Foreign Key (courses.id), Not Null | 所属课程ID |
| title | VARCHAR(255) | Not Null | 课时标题 |
| order\_index | INTEGER | Not Null, Default 0 | 课时在课程中的显示顺序 |
| created\_at | TIMESTAMPTZ | Not Null | 创建时间 |
| updated\_at | TIMESTAMPTZ | Not Null | 最后更新时间 |
| deleted\_at | TIMESTAMPTZ |  | (软删除) 伪删除标记 |

* **Table: homeworks (作业表)**  
  * **描述:** 存储课时下的作业信息，支持多种作业类型和状态管理。

| 列名 (Column) | 类型 (Type) | 约束 (Constraints) | 描述 |
| :---- | :---- | :---- | :---- |
| id | UUID | Primary Key, Not Null | 作业唯一标识符 |
| lesson_id | UUID | Foreign Key (lessons.id), Not Null | 所属课时ID |
| title | VARCHAR(255) | Not Null | 作业标题 |
| description | TEXT |  | 作业描述 |
| due_date | TIMESTAMPTZ |  | 截止时间 |
| max_score | INTEGER | Default 100 | 满分分值 |
| status | VARCHAR(50) | Not Null, Default 'DRAFT' | 作业状态 ('DRAFT', 'PUBLISHED', 'CLOSED') |
| created_at | TIMESTAMPTZ | Not Null | 创建时间 |
| updated_at | TIMESTAMPTZ | Not Null | 最后更新时间 |
| deleted_at | TIMESTAMPTZ |  | (软删除) 伪删除标记 |


* **Table: questions (题目表)**  
  * **描述:** 存储作业中的题目，支持复合题型。

| 列名 (Column) | 类型 (Type) | 约束 (Constraints) | 描述 |
| :---- | :---- | :---- | :---- |
| id | UUID | Primary Key, Not Null | 题目唯一标识符 |
| homework\_id | UUID | Foreign Key (homeworks.id), Not Null | 所属作业ID |
| parent\_id | UUID | Foreign Key (questions.id) | 父题目ID，用于复合题型 |
| question\_type | VARCHAR(50) | Not Null | 题型 (e.g., 'SINGLE\_CHOICE') |
| content | JSONB | Not Null | 题目内容 (JSON格式) |
| standard\_answer | JSONB |  | 标准答案 (JSON格式) |
| explanation | TEXT |  | 答案文字解析 |
| video\_url | VARCHAR(500) |  | 讲解视频链接 |
| order\_index | INTEGER | Not Null | 题目在作业或父题目中的顺序 |
| deleted\_at | TIMESTAMPTZ |  | **(新增)** 伪删除标记 |

##### **史诗 2 & 3: 学员提交与教师批阅**

* **Table: submissions (提交记录表)**  
  * **描述:** 记录学员的每一次作业提交，并存储批阅结果。

| 列名 (Column) | 类型 (Type) | 约束 (Constraints) | 描述 |
| :---- | :---- | :---- | :---- |
| id | UUID | Primary Key, Not Null | 提交记录唯一标识符 |
| homework\_id | UUID | Foreign Key (homeworks.id), Not Null | 所提交的作业ID |
| student\_id | UUID | Foreign Key (users.id), Not Null | 提交作业的学员ID |
| status | VARCHAR(50) | Not Null, Default 'SUBMITTED' | 提交状态 ('SUBMITTED', 'GRADED') |
| score | INTEGER |  | 教师给出的分数 |
| feedback | TEXT |  | 教师的文字评语 |
| submitted\_at | TIMESTAMPTZ | Not Null | 提交时间 |
| graded\_at | TIMESTAMPTZ |  | 批改完成的时间 |
| grader\_id | UUID | Foreign Key (users.id) | 执行批改的教师ID |
| deleted\_at | TIMESTAMPTZ |  | **(新增)** 伪删除标记 |

* **Table: student\_answers (学员答案表)**  
  * **描述:** 存储学员对每一道题目的具体答案。

| 列名 (Column) | 类型 (Type) | 约束 (Constraints) | 描述 |
| :---- | :---- | :---- | :---- |
| id | UUID | Primary Key, Not Null | 学员答案唯一标识符 |
| submission\_id | UUID | Foreign Key (submissions.id), Not Null | 所属提交记录ID |
| question\_id | UUID | Foreign Key (questions.id), Not Null | 对应的题目ID |
| answer\_content | JSONB |  | 学员提交的答案内容 (JSON格式) |
| deleted\_at | TIMESTAMPTZ |  | **(新增)** 伪删除标记 |

#### **3\. JSONB 字段结构示例**

为了支持多样化的题型，`questions`表的`content`、`standard_answer`字段以及`student_answers`表的`answer_content`字段将采用灵活的JSON结构。以下是各主要题型的详细设计规范。

##### **3.1 单选题 (SINGLE\_CHOICE)**

* **`content` (题目内容):**  
  {  
*   "stem": "“白日依山尽”的下一句是？",  
*   "options": \[  
*     { "id": "A", "text": "黄河入海流" },  
*     { "id": "B", "text": "疑是地上霜" },  
*     { "id": "C", "text": "更上一层楼" }  
*   \]  
* }  
*   
* **`standard_answer` (标准答案):**  
  {  
*   "correctOptionId": "A"  
* }  
*   
* **`answer_content` (学生答案):**  
  {  
*   "selectedOptionId": "A"  
* }  
* 

##### **3.2 多选题 (MULTIPLE\_CHOICE)**

* **`content` (题目内容):**  
  {  
*   "stem": "以下哪些诗人属于唐代？",  
*   "options": \[  
*     { "id": "A", "text": "李白" },  
*     { "id": "B", "text": "苏轼" },  
*     { "id": "C", "text": "杜甫" },  
*     { "id": "D", "text": "辛弃疾" }  
*   \]  
* }  
*   
* **`standard_answer` (标准答案):**  
  {  
*   "correctOptionIds": \["A", "C"\]  
* }  
*   
* **`answer_content` (学生答案):**  
  {  
*   "selectedOptionIds": \["A", "C"\]  
* }  
* 

##### **3.3 填空题 (FILL\_IN\_THE\_BLANK)**

* **`content` (题目内容):**  
  {  
*   "stem": "床前明月光，\_\_\_。举头望明月，\_\_\_。"  
* }  
*   
* **`standard_answer` (标准答案):**  
  {  
*   "blanks": \[  
*     { "index": 0, "text": "疑是地上霜" },  
*     { "index": 1, "text": "低头思故乡" }  
*   \]  
* }  
*   
* **`answer_content` (学生答案):**  
  {  
*   "blanks": \[  
*     { "index": 0, "text": "地上鞋两双" },  
*     { "index": 1, "text": "低头思故乡" }  
*   \]  
* }  
* 

##### **3.4 简答题 / 作文题 (SHORT\_ANSWER / ESSAY)**

* **`content` (题目内容):**  
  {  
*   "stem": "请简述你对李白诗歌风格的理解。"  
* }  
*   
* **`standard_answer` (标准答案):**  
  {  
*   "referenceText": "风格豪迈奔放，想象力丰富，语言自然流畅...",  
*   "keywords": \["豪迈", "奔放", "想象力"\]  
* }  
*   
* **`answer_content` (学生答案):**  
  {  
*   "text": "我认为李白的诗歌风格非常浪漫主义，充满了激情和想象力..."  
* }  
* 

##### **3.5 排序题 (ORDERING)**

* **`content` (题目内容):**  
  {  
*   "stem": "请将以下历史事件按时间先后顺序排列。",  
*   "items": \[  
*     { "id": "item-1", "text": "赤壁之战" },  
*     { "id": "item-2", "text": "安史之乱" },  
*     { "id": "item-3", "text": "玄武门之变" }  
*   \]  
* }  
*   
* **`standard_answer` (标准答案):**  
  {  
*   "correctOrder": \["item-1", "item-3", "item-2"\]  
* }  
*   
* **`answer_content` (学生答案):**  
  {  
*   "orderedIds": \["item-1", "item-2", "item-3"\]  
* }  
* 

##### **3.6 语音题 (SPOKEN\_ANSWER)**

* **`content` (题目内容):**  
  {  
*   "prompt": "请朗读以下段落并提交您的录音。",  
*   "textToRead": "To be, or not to be, that is the question."  
* }  
*   
* **`standard_answer` (标准答案):**  
  {  
*   "referenceAudioUrl": "https://wanli.ai/audios/ref-hamlet.mp3"  
* }  
*   
* **`answer_content` (学生答案):**  
  {  
*   "audioUrl": "https://storage.wanli.ai/submissions/student-audio-xyz.mp3"  
* }  
* 

##### **3.7 阅读理解 (READING\_COMPREHENSION)**

这是一个复合题型，通过`parent_id`字段实现。

* **父题目 (`questions`表中的一条记录):**  
  * `question_type`: 'READING\_COMPREHENSION'  
* **`content` (题目内容):**  
  {  
*   "title": "阅读以下短文，回答问题",  
*   "article": "这是一篇关于环境保护的文章，长篇大论..."  
* }  
  *   
  * `standard_answer`: `null` (父题目没有答案)  
* **子题目 (`questions`表中的另一条记录):**  
  * `parent_id`: 指向上面那条父题目的`id`  
  * `question_type`: 'SINGLE\_CHOICE' (可以是任何基础题型)  
* **`content` (题目内容):**  
  {  
*   "stem": "根据文章，造成环境污染的主要原因是什么？",  
*   "options": \[...\]  
* }  
  *   
* **`standard_answer` (标准答案):**  
  { "correctOptionId": "B" }  
  *   
  * **`student_answers`表中的记录将只关联到子题目的ID。**

#### **4. 索引设计**

为了优化查询性能，建议创建以下索引：

##### **4.1 主要查询场景索引**

* **用户相关查询**
  * `idx_users_email` - 用户登录查询
  * `idx_users_deleted_at` - 软删除过滤

* **课程相关查询**
  * `idx_courses_instructor_id` - 按教师查询课程
  * `idx_courses_status_deleted_at` - 课程状态和软删除复合查询
  * `idx_courses_created_at` - 按创建时间排序

* **课时相关查询**
  * `idx_lessons_course_id` - 按课程查询课时
  * `idx_lessons_course_id_order_index` - 课时排序查询
  * `idx_lessons_deleted_at` - 软删除过滤

* **作业相关查询**
  * `idx_homeworks_lesson_id` - 按课时查询作业
  * `idx_homeworks_status_deleted_at` - 作业状态和软删除复合查询
  * `idx_homeworks_due_date` - 按截止时间查询

* **题目相关查询**
  * `idx_questions_homework_id` - 按作业查询题目
  * `idx_questions_parent_id` - 复合题目层级查询
  * `idx_questions_deleted_at` - 软删除过滤

* **提交相关查询**
  * `idx_submissions_homework_id_student_id` - 学生作业提交查询
  * `idx_submissions_status` - 按提交状态查询
  * `idx_submissions_submitted_at` - 按提交时间排序

##### **4.2 性能优化建议**

* **分区策略**: 对于大量历史数据的表（如submissions, student_answers），可考虑按时间分区
* **覆盖索引**: 对于频繁的只读查询，创建包含所需字段的覆盖索引
* **部分索引**: 对于软删除字段，创建 `WHERE deleted_at IS NULL` 的部分索引

#### **5. 数据约束和业务规则**

##### **5.1 外键约束策略**

* **级联删除**: 不使用物理级联删除，统一使用软删除机制
* **引用完整性**: 所有外键关系都设置为 `ON DELETE RESTRICT` 防止意外删除
* **软删除检查**: 应用层确保查询时过滤已删除记录

##### **5.2 唯一性约束**

* **用户邮箱**: `UNIQUE(email) WHERE deleted_at IS NULL`
* **课程编码**: `UNIQUE(course_code) WHERE deleted_at IS NULL`
* **课时顺序**: `UNIQUE(course_id, order_index) WHERE deleted_at IS NULL`

##### **5.3 检查约束**

* **分数范围**: `CHECK (max_score > 0 AND max_score <= 1000)`
* **状态枚举**: 使用数据库枚举类型或检查约束确保状态值有效
* **时间逻辑**: `CHECK (updated_at >= created_at)`

##### **5.4 业务规则实现**

* **软删除一致性**: 删除父记录时，同时软删除所有子记录
* **权限验证**: 数据库层面不实现权限逻辑，由应用层处理
* **数据完整性**: 关键业务逻辑通过应用层事务保证

#### **6. 版本控制和迁移**

##### **6.1 数据库版本管理**

* **版本号规则**: 使用语义化版本号 (MAJOR.MINOR.PATCH)
* **迁移脚本**: 每个版本变更都有对应的SQL迁移脚本
* **回滚策略**: 提供向下兼容的回滚脚本

##### **6.2 部署策略**

* **渐进式部署**: 新字段先设为可空，数据迁移完成后再设为非空
* **零停机迁移**: 大表结构变更使用在线DDL工具
* **数据备份**: 每次结构变更前进行完整备份

---

**文档版本历史:**
- V0.1 (2025-08-20): 初始版本，基础表结构设计
- V0.2 (2025-08-22): 补充homeworks表完整定义，添加索引设计和约束说明  
*