name: SonarCloud Code Quality Check

# è§¦å‘æ¡ä»¶
on:
  push:
    branches:
      - main
      - staging
      - 'feature/**'
      - 'bugfix/**'
      - 'hotfix/**'
  pull_request:
    branches:
      - main
      - staging
    types: [opened, synchronize, reopened]

# ç¯å¢ƒå˜é‡
env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: '-Xmx3072m'

jobs:
  sonarcloud-check:
    name: SonarCloud Quality Gate
    runs-on: ubuntu-latest
    
    # æƒé™è®¾ç½®
    permissions:
      contents: read
      pull-requests: write
      checks: write
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼ŒSonarQubeéœ€è¦
      
      # 2. è®¾ç½®Javaç¯å¢ƒ
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
      
      # 3. ç¼“å­˜Mavenä¾èµ–
      - name: Cache Maven Dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      
      # 4. ç¼“å­˜SonarQubeåŒ…
      - name: Cache SonarQube Packages
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      
      # 5. è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
      - name: Run Tests with Coverage
        run: |
          ./mvnw clean verify \
            -Dmaven.test.failure.ignore=false \
            -Dspring.profiles.active=test \
            -Djacoco.skip=false
        env:
          SPRING_PROFILES_ACTIVE: test
      
      # 6. è¿è¡ŒSonarCloudåˆ†æ
      - name: Run SonarCloud Analysis
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          ./mvnw sonar:sonar \
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }} \
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }} \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }} \
            -Dsonar.branch.name=${{ github.ref_name }} \
            -Dsonar.pullrequest.key=${{ github.event.number }} \
            -Dsonar.pullrequest.branch=${{ github.head_ref }} \
            -Dsonar.pullrequest.base=${{ github.base_ref }} \
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
            -Dsonar.java.binaries=target/classes \
            -Dsonar.java.test.binaries=target/test-classes
      
      # 7. ç­‰å¾…è´¨é‡é—¨ç»“æœ
      - name: Wait for Quality Gate
        uses: sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
      
      # 8. ä¸Šä¼ æµ‹è¯•ç»“æœ
      - name: Upload Test Results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results
          path: |
            target/surefire-reports/
            target/site/jacoco/
            target/sonar/
      
      # 9. å‘å¸ƒæµ‹è¯•æŠ¥å‘Š
      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
          report_paths: 'target/surefire-reports/TEST-*.xml'
          check_name: 'Unit Test Results'
          fail_on_failure: true
      
      # 10. è¯„è®ºPRï¼ˆä»…åœ¨PRæ—¶æ‰§è¡Œï¼‰
      - name: Comment PR with SonarQube Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const sonarUrl = 'https://sonarcloud.io';
            const projectKey = process.env.SONAR_PROJECT_KEY || 'wanli-education-backend';
            const organization = process.env.SONAR_ORGANIZATION;
            const prNumber = context.payload.pull_request.number;
            
            const comment = `## ğŸ” SonarCloudä»£ç è´¨é‡æ£€æŸ¥ç»“æœ
            
            ğŸ“Š **åˆ†ææŠ¥å‘Š:** [æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š](${sonarUrl}/project/pull_requests?id=${projectKey}&pullRequest=${prNumber})
            
            âœ… **è´¨é‡é—¨çŠ¶æ€:** å·²é€šè¿‡
            
            ### ğŸ“‹ æ£€æŸ¥é¡¹ç›®
            - ä»£ç è¦†ç›–ç‡ â‰¥ 80%
            - é‡å¤ä»£ç ç‡ â‰¤ 3%
            - ç»´æŠ¤æ€§è¯„çº§ â‰¥ A
            - å¯é æ€§è¯„çº§ â‰¥ A
            - å®‰å…¨æ€§è¯„çº§ â‰¥ A
            
            > ğŸ’¡ å¦‚æœè´¨é‡é—¨æœªé€šè¿‡ï¼Œè¯·æ ¹æ®SonarCloudæŠ¥å‘Šä¿®å¤ç›¸å…³é—®é¢˜åé‡æ–°æäº¤ã€‚`;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
        env:
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
          SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}

  # å®‰å…¨æ‰«æä½œä¸š
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    needs: sonarcloud-check
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout Code
        uses: actions/checkout@v4
      
      # 2. è®¾ç½®Javaç¯å¢ƒ
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
      
      # 3. è¿è¡ŒOWASPä¾èµ–æ£€æŸ¥
      - name: Run OWASP Dependency Check
        run: |
          ./mvnw org.owasp:dependency-check-maven:check \
            -DfailBuildOnCVSS=7 \
            -DsuppressionsLocation=owasp-suppressions.xml
      
      # 4. ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
      - name: Upload Security Report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-report
          path: target/dependency-check-report.html

  # ä»£ç æ ¼å¼æ£€æŸ¥
  code-format-check:
    name: Code Format Check
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout Code
        uses: actions/checkout@v4
      
      # 2. è®¾ç½®Javaç¯å¢ƒ
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
      
      # 3. æ£€æŸ¥ä»£ç æ ¼å¼
      - name: Check Code Format
        run: |
          ./mvnw spotless:check
      
      # 4. å¦‚æœæ ¼å¼æ£€æŸ¥å¤±è´¥ï¼Œæä¾›ä¿®å¤å»ºè®®
      - name: Format Check Failed
        if: failure()
        run: |
          echo "âŒ ä»£ç æ ¼å¼æ£€æŸ¥å¤±è´¥ï¼"
          echo "ğŸ’¡ è¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ä¿®å¤æ ¼å¼é—®é¢˜ï¼š"
          echo "   ./mvnw spotless:apply"
          echo "   git add ."
          echo "   git commit -m 'style: ä¿®å¤ä»£ç æ ¼å¼'"
          exit 1